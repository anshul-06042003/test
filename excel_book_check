import pandas as pd
import os
import random

# ==========================
# CONFIG
# ==========================
INPUT_EXCEL = r"D:\Metering_data\Load_Survey November month (2).xlsx"
OUTPUT_DIR = r"D:\Metering_data\excel_split_books"
SAMPLE_ROWS = 5   # kitne random rows check karne hain per sheet
# ==========================


def validate_excel_split(input_excel, output_dir):
    print("\nüîç STARTING EXCEL SPLIT VALIDATION\n")

    xls = pd.ExcelFile(input_excel)
    all_ok = True

    for sheet in xls.sheet_names:
        print(f"\nüìÑ Checking sheet: {sheet}")

        output_file = os.path.join(output_dir, f"{sheet}.xlsx")

        # 1Ô∏è‚É£ Sheet file exists?
        if not os.path.exists(output_file):
            print(f"‚ùå FAIL: Output file missing for sheet '{sheet}'")
            all_ok = False
            continue
        else:
            print("‚úî Output file exists")

        # Read data
        orig_df = pd.read_excel(input_excel, sheet_name=sheet)
        out_df = pd.read_excel(output_file)

        # 2Ô∏è‚É£ Row count check
        if len(orig_df) == len(out_df):
            print(f"‚úî Row count match: {len(orig_df)}")
        else:
            print(f"‚ùå FAIL: Row count mismatch (orig={len(orig_df)}, out={len(out_df)})")
            all_ok = False
            continue

        # 3Ô∏è‚É£ Column structure check
        if list(orig_df.columns) == list(out_df.columns):
            print("‚úî Column names & order match")
        else:
            print("‚ùå FAIL: Column mismatch")
            print("Original:", list(orig_df.columns))
            print("Output  :", list(out_df.columns))
            all_ok = False
            continue

        # 4Ô∏è‚É£ Random sample data check
        if len(orig_df) > 0:
            for _ in range(min(SAMPLE_ROWS, len(orig_df))):
                idx = random.randint(0, len(orig_df) - 1)
                if not orig_df.iloc[idx].equals(out_df.iloc[idx]):
                    print(f"‚ùå FAIL: Data mismatch at row index {idx}")
                    all_ok = False
                    break
            else:
                print(f"‚úî {SAMPLE_ROWS} random rows matched")
        else:
            print("‚ö† Sheet is empty (skipped data check)")

    print("\n==============================")
    if all_ok:
        print("üéâ FINAL RESULT: ‚úÖ PASS ‚Äî DATA 100% SAFE")
    else:
        print("üö® FINAL RESULT: ‚ùå FAIL ‚Äî DATA ISSUE FOUND")
    print("==============================\n")


# RUN VALIDATION
validate_excel_split(INPUT_EXCEL, OUTPUT_DIR)
